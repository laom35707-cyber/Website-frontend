<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç§äººæ—¥è®°</title>
<style>
  :root{
    --bg: #fbfbfd;
    --card: #ffffff;
    --muted: #8a8a98;
    --accent: #2b2bff;
    --soft: #f4f6fb;
    --radius: 16px;
    --shadow: 0 8px 30px rgba(20,20,40,0.06);
    font-family: "Inter", "Helvetica Neue", Arial, serif;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#ffffff 0%, #fbfbfd 100%);color:#111;}
  .wrap{ max-width:960px; margin:36px auto; padding:0 20px 140px; }

  header.top{
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;
  }
  header.top h1{ margin:0; font-size:20px; letter-spacing:1px; font-weight:600; color:#111; }
  header.top .small{ color:var(--muted); font-size:13px; }

  .editor {
    background:var(--card); border-radius:var(--radius); padding:22px; box-shadow:var(--shadow); border:1px solid #f0f0f6;
  }
  .meta-row{ display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
  .meta-left{ display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px; }
  .pill{ background:var(--soft); color:#444; padding:6px 10px; border-radius:999px; font-size:13px; border:1px solid #f0f0f6; }
  .date-line{ color:var(--muted); font-size:13px; }

  .title-input{ width:100%; border:none; font-size:18px; font-weight:600; padding:6px 0; outline:none; margin-bottom:6px; }
  .content{
    min-height:220px; border-radius:12px; padding:12px; outline:none; font-size:16px; line-height:1.9; color:#222; background:linear-gradient(180deg,#fff 0,#fbfbfd 100%); border:1px dashed #f0f0f6;
  }
  .content:empty:before { content: "å†™ç‚¹ä»€ä¹ˆï¼Œè®°å½•ä»Šå¤©çš„æ¸©åº¦ã€ç¬é—´ä¸ç»†èŠ‚â€¦"; color:#bdbdbf; }

  .tool-row{ display:flex; justify-content:space-between; align-items:center; margin-top:14px; gap:12px; flex-wrap:wrap; }
  .left-tools{ display:flex; gap:8px; align-items:center; }
  .btn {
    background: #fff; border:1px solid #eee; padding:8px 12px; border-radius:12px; cursor:pointer; font-size:13px;
  }
  .btn.primary { background: linear-gradient(90deg,#2b2bff,#6b5ce7); color:#fff; border:0; box-shadow:0 8px 18px rgba(107,92,231,0.12); }
  .small-muted{ color:var(--muted); font-size:13px; }

  .feed{ margin-top:26px; display:grid; gap:16px; }
  .post {
    background:var(--card); border-radius:14px; padding:18px; box-shadow: 0 6px 20px rgba(20,20,40,0.04);
    border: 1px solid #fafafa;
  }
  .post .meta{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .post .title{ font-weight:600; margin-bottom:8px; font-size:16px; }
  .post .text{ color:#222; line-height:1.7; white-space:pre-wrap; margin-bottom:10px; }
  
  /* åª’ä½“å†…å®¹æ ·å¼ */
  .media-container {
    margin: 16px 0;
    max-width: 100%;
  }
  .media-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    margin: 12px 0;
    border: 1px solid #f0f0f0;
    background: #fafafa;
  }
  .drive-image, .drive-video {
    display: block;
    max-width: 100%;
    max-height: 400px;
    margin: 0 auto;
  }
  .drive-video {
    width: 100%;
    height: auto;
  }
  .media-caption {
    font-size: 13px;
    color: #666;
    padding: 8px 12px;
    background: #f9f9f9;
    border-top: 1px solid #f0f0f0;
  }
  .media-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 14px;
    cursor: pointer;
    display: none;
  }
  .media-item:hover .media-remove {
    display: block;
  }
  
  /* åª’ä½“æ’å…¥æ¨¡æ€æ¡† */
  .media-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .media-modal {
    background: white;
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .media-modal h3 {
    margin: 0 0 16px 0;
    font-size: 18px;
  }
  .media-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 14px;
  }
  .media-input:focus {
    outline: none;
    border-color: #2b2bff;
  }
  .media-buttons {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 16px;
  }
  .media-hint {
    font-size: 13px;
    color: #888;
    margin-top: 8px;
    line-height: 1.5;
  }
  .media-hint a {
    color: #2b2bff;
    text-decoration: none;
  }
  .media-hint a:hover {
    text-decoration: underline;
  }

  .trash-modal-overlay {
    position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.3); z-index: 1000; display:none; align-items:center; justify-content:center;
  }
  .trash-panel{
    width: 90%; max-width: 500px; max-height: 70vh; overflow:auto; background:var(--card);
    border-radius:20px 20px 12px 12px; box-shadow:0 -10px 40px rgba(0,0,0,0.12); padding:20px; border:1px solid #f0f0f6;
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 1001;
    display: none;
  }
  .trash-header {
    display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid #f0f0f6;
  }
  .trash-header h3 { margin:0; font-size:18px; }
  .trash-item{ display:flex; gap:10px; align-items:flex-start; padding:12px 0; border-bottom:1px solid #fafafa; }
  .trash-item .time{ color:var(--muted); font-size:12px; }
  .trash-actions { display:flex; gap:8px; margin-top:4px; }

  /* å¯¼èˆªæ æ ·å¼ä¿®æ”¹ */
  .nav-container {
    position: fixed; 
    bottom: 12px; 
    left: 2%; 
    width: 96%; 
    height: 80px; 
    background: #fff; 
    border-radius: 18px; 
    border: 1px solid #e8e8e8;
    display: flex; 
    justify-content: center; 
    align-items: center; 
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }
  .button-group { 
    width: 100%; 
    display: flex; 
    justify-content: space-around; 
    align-items: center; 
    max-width:600px;
  }
  .nav-btn { 
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer; 
    padding: 8px 12px;
    border-radius: 12px;
    transition: all 0.2s ease;
    min-width: 60px;
  }
  .nav-btn:hover {
    background: rgba(0,0,0,0.03);
  }
  .nav-btn.active {
    background: rgba(43, 43, 255, 0.1);
  }
  .nav-btn .emoji {
    font-size: 24px;
    margin-bottom: 4px;
  }
  .nav-btn .text {
    font-size: 12px;
    font-weight: 500;
    color: #333;
  }
  .nav-btn.active .text {
    color: #2b2bff;
    font-weight: 600;
  }

  @media (max-width:640px){
    .trash-panel{ width:95%; max-height:60vh; }
    .media-modal { width: 95%; padding: 16px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <div>
      <h1>ç§äººæ—¥è®°</h1>
      <div class="small">è‡ªåŠ¨å¤‡ä»½ Â· è·¨è®¾å¤‡åŒæ­¥</div>
    </div>
    <div class="small-muted" id="connStatus">è¿æ¥ï¼šæ£€æŸ¥ä¸­â€¦</div>
  </header>

  <section class="editor" aria-label="å†™æ—¥è®°">
    <div class="meta-row">
      <div class="meta-left">
        <div class="pill" id="statusPill">è‰ç¨¿</div>
        <div class="date-line" id="dateLine">æ­£åœ¨ç”Ÿæˆæ—¶é—´â€¦</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <input id="weatherInput" placeholder="å¤©æ°”ï¼ˆæ‰‹åŠ¨å¡«å†™ï¼‰" style="border:none;border-bottom:1px solid #eee;padding:6px 8px;border-radius:8px;outline:none;font-size:13px" />
      </div>
    </div>

    <input id="title" class="title-input" placeholder="å†™ä¸€ä¸ªæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" />

    <div id="content" class="content" contenteditable="true"></div>

    <div class="tool-row">
      <div class="left-tools">
        <button class="btn" id="loadDraftBtn">è½½å…¥è‰ç¨¿</button>
        <button class="btn" id="insertMediaBtn">æ’å…¥åª’ä½“</button>
        <button class="btn" id="openTrashBtn">åƒåœ¾æ¡¶</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div class="small-muted" id="autoHint">è‡ªåŠ¨å¤‡ä»½ï¼šåœæ­¢è¾“å…¥å2ç§’å¤‡ä»½ Â· å‘å¸ƒåæ¸…é™¤äº‘ç«¯å¤‡ä»½</div>
        <button id="publishBtn" class="btn primary">å‘å¸ƒ</button>
      </div>
    </div>
  </section>

  <section class="feed" id="feed">
  </section>
</div>

<!-- åª’ä½“æ’å…¥æ¨¡æ€æ¡† -->
<div id="mediaOverlay" class="media-modal-overlay">
  <div class="media-modal">
    <h3>æ’å…¥Google Driveåª’ä½“</h3>
    <input type="text" id="mediaUrlInput" class="media-input" placeholder="è¾“å…¥Google Driveå›¾ç‰‡æˆ–è§†é¢‘é“¾æ¥" />
    <input type="text" id="mediaCaptionInput" class="media-input" placeholder="åª’ä½“æè¿°ï¼ˆå¯é€‰ï¼‰" />
    
    <div class="media-hint">
      <strong>å¦‚ä½•è·å–Google Driveé“¾æ¥ï¼š</strong><br>
      1. åœ¨Google Driveä¸­å³é”®ç‚¹å‡»æ–‡ä»¶ â†’ "è·å–é“¾æ¥"<br>
      2. å°†æƒé™è®¾ç½®ä¸º"çŸ¥é“é“¾æ¥çš„ä»»ä½•äºº"<br>
      3. å¤åˆ¶é“¾æ¥å¹¶ç²˜è´´åˆ°ä¸Šæ–¹<br>
      4. ç¡®ä¿é“¾æ¥ä¸­åŒ…å«"drive.google.com/file/d/"å­—æ ·
    </div>
    
    <div class="media-buttons">
      <button class="btn" id="cancelMediaBtn">å–æ¶ˆ</button>
      <button class="btn primary" id="insertMediaConfirmBtn">æ’å…¥</button>
    </div>
  </div>
</div>

<div id="trashOverlay" class="trash-modal-overlay"></div>
<div id="trashPanel" class="trash-panel">
  <div class="trash-header">
    <h3>åƒåœ¾æ¡¶</h3>
    <button id="closeTrash" class="btn">å…³é—­</button>
  </div>
  <div id="trashList">
  </div>
</div>

<!-- ä¿®æ”¹åçš„å¯¼èˆªæ  -->
<div class="nav-container">
  <div class="button-group">
    <div class="nav-btn" onclick="location.href='index.html'">
      <div class="emoji">ğŸ </div>
      <div class="text">ä¸»é¡µ</div>
    </div>
    <div class="nav-btn" onclick="location.href='study.html'">
      <div class="emoji">ğŸ“š</div>
      <div class="text">å­¦ä¹ </div>
    </div>
    <div class="nav-btn active" onclick="location.href='diary.html'">
      <div class="emoji">ğŸ““</div>
      <div class="text">æ—¥è®°</div>
    </div>
    <div class="nav-btn" onclick="location.href='w.html'">
      <div class="emoji">âš™ï¸</div>
      <div class="text">çŠ¶æ€</div>
    </div>
  </div>
</div>

<script>
// ============================================
// å¸¸é‡å®šä¹‰
// ============================================
const DRAFT_KEY = 'diary:draft:v4';
const PUBLISHED_FEED = 'diary:published_feed:v4';
const BACKUP_DELAY = 2000; // åœæ­¢è¾“å…¥å2ç§’å¤‡ä»½

// ============================================
// å·¥å…·å‡½æ•°
// ============================================
function uuidv4(){ 
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{ 
    const r = Math.random() * 16 | 0; 
    const v = c === 'x' ? r : (r & 0x3 | 0x8); 
    return v.toString(16); 
  }); 
}

function formatFullTimestamp(d){
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const date = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const mm = String(d.getMinutes()).padStart(2, '0');
  const ss = String(d.getSeconds()).padStart(2, '0');
  const weekday = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'][d.getDay()];
  
  const monthNum = d.getMonth() + 1;
  let season;
  if (monthNum === 12 || monthNum <= 2) season = 'å†¬å­£';
  else if (monthNum >= 3 && monthNum <= 5) season = 'æ˜¥å­£';
  else if (monthNum >= 6 && monthNum <= 8) season = 'å¤å­£';
  else season = 'ç§‹å­£';
  
  return `${year}å¹´${month}æœˆ${date}æ—¥ ${hh}:${mm}:${ss} Â· ${weekday} Â· ${season}`;
}

function getSeason(d){
  const m = d.getMonth() + 1;
  if (m === 12 || m <= 2) return 'å†¬å­£';
  if (m >= 3 && m <= 5) return 'æ˜¥å­£';
  if (m >= 6 && m <= 8) return 'å¤å­£';
  return 'ç§‹å­£';
}

// Google Driveé“¾æ¥è½¬æ¢å‡½æ•°
function convertGoogleDriveLink(url) {
  if (!url) return null;
  
  // æå–æ–‡ä»¶ID
  const fileIdMatch = url.match(/\/d\/([^\/]+)/) || url.match(/id=([^&]+)/);
  if (!fileIdMatch) return null;
  
  const fileId = fileIdMatch[1];
  
  // æ£€æŸ¥æ–‡ä»¶ç±»å‹
  const isVideo = /\.(mp4|mov|avi|mkv|wmv|flv|webm)$/i.test(url);
  
  if (isVideo) {
    // è§†é¢‘é¢„è§ˆé“¾æ¥
    return `https://drive.google.com/file/d/${fileId}/preview`;
  } else {
    // å›¾ç‰‡ç›´æ¥é“¾æ¥
    return `https://drive.google.com/uc?export=view&id=${fileId}`;
  }
}

// ============================================
// DOM å…ƒç´ å¼•ç”¨
// ============================================
const el = {
  statusPill: document.getElementById('statusPill'),
  dateLine: document.getElementById('dateLine'),
  title: document.getElementById('title'),
  content: document.getElementById('content'),
  weather: document.getElementById('weatherInput'),
  publishBtn: document.getElementById('publishBtn'),
  loadDraftBtn: document.getElementById('loadDraftBtn'),
  insertMediaBtn: document.getElementById('insertMediaBtn'),
  feed: document.getElementById('feed'),
  connStatus: document.getElementById('connStatus'),
  trashOverlay: document.getElementById('trashOverlay'),
  trashPanel: document.getElementById('trashPanel'),
  trashList: document.getElementById('trashList'),
  openTrashBtn: document.getElementById('openTrashBtn'),
  closeTrashBtn: document.getElementById('closeTrash'),
  autoHint: document.getElementById('autoHint'),
  // åª’ä½“ç›¸å…³å…ƒç´ 
  mediaOverlay: document.getElementById('mediaOverlay'),
  mediaUrlInput: document.getElementById('mediaUrlInput'),
  mediaCaptionInput: document.getElementById('mediaCaptionInput'),
  cancelMediaBtn: document.getElementById('cancelMediaBtn'),
  insertMediaConfirmBtn: document.getElementById('insertMediaConfirmBtn')
};

// ============================================
// çŠ¶æ€å˜é‡
// ============================================
let autosaveTimer = null;
let backupTimeout = null;
let currentDraft = null;
let online = navigator.onLine;

// ============================================
// åª’ä½“ç®¡ç†åŠŸèƒ½
// ============================================
function showMediaDialog() {
  el.mediaUrlInput.value = '';
  el.mediaCaptionInput.value = '';
  el.mediaOverlay.style.display = 'flex';
}

function hideMediaDialog() {
  el.mediaOverlay.style.display = 'none';
}

function insertMedia() {
  const url = el.mediaUrlInput.value.trim();
  const caption = el.mediaCaptionInput.value.trim();
  
  if (!url) {
    alert('è¯·è¾“å…¥Google Driveé“¾æ¥');
    return;
  }
  
  // è½¬æ¢Google Driveé“¾æ¥
  const mediaUrl = convertGoogleDriveLink(url);
  if (!mediaUrl) {
    alert('æ— æ•ˆçš„Google Driveé“¾æ¥ã€‚è¯·ç¡®ä¿é“¾æ¥æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å«æ–‡ä»¶IDã€‚');
    return;
  }
  
  // æ£€æµ‹æ˜¯å¦ä¸ºè§†é¢‘
  const isVideo = /preview$/.test(mediaUrl) || /\.(mp4|mov|avi|mkv|wmv|flv|webm)$/i.test(url);
  
  // åˆ›å»ºåª’ä½“å®¹å™¨
  const mediaContainer = document.createElement('div');
  mediaContainer.className = 'media-container';
  
  const mediaId = `media-${Date.now()}`;
  const mediaItem = document.createElement('div');
  mediaItem.className = 'media-item';
  mediaItem.dataset.mediaId = mediaId;
  mediaItem.dataset.originalUrl = url;
  mediaItem.dataset.mediaUrl = mediaUrl;
  mediaItem.dataset.caption = caption;
  mediaItem.dataset.type = isVideo ? 'video' : 'image';
  
  // åˆ›å»ºç§»é™¤æŒ‰é’®
  const removeBtn = document.createElement('button');
  removeBtn.className = 'media-remove';
  removeBtn.innerHTML = 'Ã—';
  removeBtn.onclick = function(e) {
    e.stopPropagation();
    if (confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªåª’ä½“å—ï¼Ÿ')) {
      mediaContainer.remove();
      saveContentToDraft();
    }
  };
  
  if (isVideo) {
    // è§†é¢‘å…ƒç´ 
    const video = document.createElement('iframe');
    video.className = 'drive-video';
    video.src = mediaUrl;
    video.frameBorder = '0';
    video.allow = 'autoplay; encrypted-media';
    video.allowFullscreen = true;
    video.style.width = '100%';
    video.style.height = '400px';
    mediaItem.appendChild(video);
  } else {
    // å›¾ç‰‡å…ƒç´ 
    const img = document.createElement('img');
    img.className = 'drive-image';
    img.src = mediaUrl;
    img.alt = caption || 'Google Driveå›¾ç‰‡';
    img.style.maxWidth = '100%';
    img.style.maxHeight = '400px';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    img.onerror = function() {
      this.style.display = 'none';
      const errorDiv = document.createElement('div');
      errorDiv.style.padding = '20px';
      errorDiv.style.textAlign = 'center';
      errorDiv.style.color = '#999';
      errorDiv.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æƒé™';
      mediaItem.appendChild(errorDiv);
    };
    mediaItem.appendChild(img);
  }
  
  mediaItem.appendChild(removeBtn);
  
  // å¦‚æœæœ‰æè¿°ï¼Œæ·»åŠ æè¿°
  if (caption) {
    const captionDiv = document.createElement('div');
    captionDiv.className = 'media-caption';
    captionDiv.textContent = caption;
    mediaItem.appendChild(captionDiv);
  }
  
  mediaContainer.appendChild(mediaItem);
  
  // æ’å…¥åˆ°ç¼–è¾‘å™¨
  const content = el.content;
  const selection = window.getSelection();
  
  if (selection.rangeCount > 0) {
    const range = selection.getRangeAt(0);
    range.insertNode(mediaContainer);
    
    // åœ¨åª’ä½“åæ·»åŠ ä¸€ä¸ªæ¢è¡Œ
    const br = document.createElement('br');
    range.insertNode(br);
    
    // ç§»åŠ¨å…‰æ ‡åˆ°åª’ä½“å
    range.setStartAfter(br);
    range.setEndAfter(br);
    selection.removeAllRanges();
    selection.addRange(range);
  } else {
    // å¦‚æœæ²¡æœ‰é€‰ä¸­åŒºåŸŸï¼Œæ·»åŠ åˆ°æœ«å°¾
    content.appendChild(mediaContainer);
    const br = document.createElement('br');
    content.appendChild(br);
  }
  
  // ä¿å­˜åˆ°è‰ç¨¿
  saveContentToDraft();
  hideMediaDialog();
  
  // æ»šåŠ¨åˆ°æ’å…¥çš„åª’ä½“
  mediaContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ä»HTMLä¸­æå–åª’ä½“æ•°æ®
function extractMediaFromContent(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const mediaItems = doc.querySelectorAll('.media-item');
  const mediaData = [];
  
  mediaItems.forEach(item => {
    mediaData.push({
      id: item.dataset.mediaId,
      originalUrl: item.dataset.originalUrl,
      mediaUrl: item.dataset.mediaUrl,
      caption: item.dataset.caption,
      type: item.dataset.type
    });
  });
  
  return mediaData;
}

// æ¸²æŸ“åª’ä½“åˆ°å†…å®¹
function renderMediaToContent(contentDiv, contentHtml) {
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = contentHtml;
  
  // æŸ¥æ‰¾å¹¶æ›¿æ¢åª’ä½“å ä½ç¬¦
  const mediaItems = tempDiv.querySelectorAll('.media-item');
  mediaItems.forEach(item => {
    const mediaId = item.dataset.mediaId;
    const mediaUrl = item.dataset.mediaUrl;
    const caption = item.dataset.caption;
    const type = item.dataset.type;
    
    if (!mediaUrl) return;
    
    const mediaContainer = document.createElement('div');
    mediaContainer.className = 'media-container';
    
    const mediaItem = document.createElement('div');
    mediaItem.className = 'media-item';
    mediaItem.dataset.mediaId = mediaId;
    mediaItem.dataset.originalUrl = item.dataset.originalUrl || '';
    mediaItem.dataset.mediaUrl = mediaUrl;
    mediaItem.dataset.caption = caption;
    mediaItem.dataset.type = type;
    
    // åˆ›å»ºç§»é™¤æŒ‰é’®ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
    const removeBtn = document.createElement('button');
    removeBtn.className = 'media-remove';
    removeBtn.innerHTML = 'Ã—';
    removeBtn.onclick = function(e) {
      e.stopPropagation();
      if (confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªåª’ä½“å—ï¼Ÿ')) {
        mediaContainer.remove();
        saveContentToDraft();
      }
    };
    
    if (type === 'video') {
      const video = document.createElement('iframe');
      video.className = 'drive-video';
      video.src = mediaUrl;
      video.frameBorder = '0';
      video.allow = 'autoplay; encrypted-media';
      video.allowFullscreen = true;
      video.style.width = '100%';
      video.style.height = '400px';
      mediaItem.appendChild(video);
    } else {
      const img = document.createElement('img');
      img.className = 'drive-image';
      img.src = mediaUrl;
      img.alt = caption || 'Google Driveå›¾ç‰‡';
      img.style.maxWidth = '100%';
      img.style.maxHeight = '400px';
      img.style.display = 'block';
      img.style.margin = '0 auto';
      img.onerror = function() {
        this.style.display = 'none';
        const errorDiv = document.createElement('div');
        errorDiv.style.padding = '20px';
        errorDiv.style.textAlign = 'center';
        errorDiv.style.color = '#999';
        errorDiv.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æƒé™';
        mediaItem.appendChild(errorDiv);
      };
      mediaItem.appendChild(img);
    }
    
    // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ·»åŠ ç§»é™¤æŒ‰é’®
    if (contentDiv.isContentEditable) {
      mediaItem.appendChild(removeBtn);
    }
    
    if (caption) {
      const captionDiv = document.createElement('div');
      captionDiv.className = 'media-caption';
      captionDiv.textContent = caption;
      mediaItem.appendChild(captionDiv);
    }
    
    mediaContainer.appendChild(mediaItem);
    item.replaceWith(mediaContainer);
  });
  
  return tempDiv.innerHTML;
}

// ä¿å­˜å†…å®¹åˆ°è‰ç¨¿
function saveContentToDraft() {
  currentDraft.content = el.content.innerHTML;
  saveLocalDraft(currentDraft);
}

// ============================================
// è‰ç¨¿ç®¡ç†
// ============================================
function loadLocalDraft(){
  try{
    const raw = localStorage.getItem(DRAFT_KEY);
    if (raw) {
      const draft = JSON.parse(raw);
      // ç¡®ä¿æ—§æ•°æ®å…¼å®¹
      if (!draft.id) draft.id = uuidv4();
      if (!draft.createdAt) draft.createdAt = new Date().toISOString();
      if (!draft.updatedAt) draft.updatedAt = new Date().toISOString();
      return draft;
    }
  } catch(e){
    console.log('è¯»å–æœ¬åœ°è‰ç¨¿å¤±è´¥:', e);
  }
  
  const id = uuidv4();
  const now = new Date().toISOString();
  const d = { 
    id, 
    title: '', 
    content: '', 
    weather: '', 
    createdAt: now, 
    updatedAt: now 
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
  return d;
}

function saveLocalDraft(d){
  d.updatedAt = new Date().toISOString();
  localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
}

// ============================================
// äº‘ç«¯å¤‡ä»½åŠŸèƒ½ï¼ˆé˜²æŠ–ï¼‰
// ============================================
async function backupToCloud() {
  if (!navigator.onLine) return;
  
  const payload = {
    id: currentDraft.id,
    title: currentDraft.title,
    content: currentDraft.content,
    weather: currentDraft.weather,
    updatedAt: new Date().toISOString(),
    readableTimestamp: formatFullTimestamp(new Date())
  };
  
  try {
    const response = await fetch('/api/backup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.ok) {
        // å¤‡ä»½æˆåŠŸï¼Œæ›´æ–°çŠ¶æ€æ˜¾ç¤º
        const now = new Date();
        const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        el.autoHint.textContent = `å·²å¤‡ä»½ ${timeStr}`;
        el.autoHint.style.color = '#10b981';
        
        // 3ç§’åæ¢å¤åŸè‰²
        setTimeout(() => {
          el.autoHint.style.color = '';
          el.autoHint.textContent = 'è‡ªåŠ¨å¤‡ä»½ï¼šåœæ­¢è¾“å…¥å2ç§’å¤‡ä»½ Â· å‘å¸ƒåæ¸…é™¤äº‘ç«¯å¤‡ä»½';
        }, 3000);
      }
    }
  } catch (e) {
    console.log('äº‘ç«¯å¤‡ä»½å¤±è´¥ï¼ˆå¯èƒ½ç¦»çº¿ï¼‰:', e.message);
  }
}

function scheduleBackup() {
  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (backupTimeout) {
    clearTimeout(backupTimeout);
  }
  
  // è®¾ç½®æ–°çš„å®šæ—¶å™¨
  backupTimeout = setTimeout(() => {
    if (navigator.onLine) {
      backupToCloud();
    }
  }, BACKUP_DELAY);
}

// ============================================
// è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
// ============================================
function startAutosave() {
  if (autosaveTimer) return;
  
  // æœ¬åœ°è‡ªåŠ¨ä¿å­˜ï¼ˆå®æ—¶ï¼‰
  autosaveTimer = setInterval(() => {
    currentDraft.title = el.title.value;
    currentDraft.content = el.content.innerHTML;
    currentDraft.weather = el.weather.value;
    currentDraft.updatedAt = new Date().toISOString();
    saveLocalDraft(currentDraft);
    
    el.dateLine.innerText = formatFullTimestamp(new Date());
  }, 500);
}

async function stopAutosaveAndCleanup(){
  if (autosaveTimer) { 
    clearInterval(autosaveTimer); 
    autosaveTimer = null; 
  }
  
  if (backupTimeout) {
    clearTimeout(backupTimeout);
    backupTimeout = null;
  }
  
  localStorage.removeItem(DRAFT_KEY);
  
  try { 
    await fetch('/api/delete-backup', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ id: currentDraft.id }) 
    }); 
  } catch(e) {
    console.log('æ¸…é™¤äº‘ç«¯å¤‡ä»½å¤±è´¥:', e.message);
  }
}

// ============================================
// å‘å¸ƒåŠŸèƒ½
// ============================================
el.publishBtn.addEventListener('click', async ()=>{
  if(!confirm('ç¡®è®¤å‘å¸ƒï¼Ÿå‘å¸ƒåè‰ç¨¿å¤‡ä»½ä¼šè¢«æ¸…é™¤ï¼Œå†…å®¹å°†å‡ºç°åœ¨å·²å‘å¸ƒåˆ—è¡¨ã€‚')) return;
  
  const payload = {
    id: currentDraft.id,
    title: currentDraft.title,
    content: currentDraft.content,
    weather: currentDraft.weather,
    publishedAtISO: new Date().toISOString(),
    publishedReadable: formatFullTimestamp(new Date())
  };
  
  try{
    const res = await fetch('/api/publish', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify(payload) 
    });
    
    if(!res.ok) throw new Error('å‘å¸ƒè¯·æ±‚å¤±è´¥');
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'å‘å¸ƒé”™è¯¯');
    
    await stopAutosaveAndCleanup();
    const feed = JSON.parse(localStorage.getItem(PUBLISHED_FEED) || '[]');
    feed.push(payload);
    localStorage.setItem(PUBLISHED_FEED, JSON.stringify(feed));
    
    await loadPosts();
    alert('å‘å¸ƒæˆåŠŸ');
    
    // é‡ç½®ç¼–è¾‘å™¨
    currentDraft = loadLocalDraft();
    el.title.value = '';
    el.content.innerHTML = '';
    el.weather.value = '';
    saveLocalDraft(currentDraft);
    
  } catch(e){
    alert('å‘å¸ƒå¤±è´¥ï¼š' + e.message);
    console.error(e);
  }
});

// ============================================
// æ–‡ç« ç®¡ç†
// ============================================
async function deletePost(id, titleText){
  if(!confirm(`ç¡®è®¤åˆ é™¤ "${titleText||'æ— æ ‡é¢˜'}"ï¼Ÿï¼ˆæ­¤æ“ä½œä¼šç§»åˆ°åƒåœ¾æ¡¶ï¼‰`)) return;
  if(!confirm('è¯·å†æ¬¡ç¡®è®¤ï¼šä½ ç¡®å®šè¦æŠŠè¿™ç¯‡æ—¥è®°ç§»åˆ°åƒåœ¾æ¡¶å—ï¼Ÿå¯åœ¨åƒåœ¾æ¡¶æ¢å¤ï¼Œ24å°æ—¶åè‡ªåŠ¨æ¸…é™¤ã€‚')) return;
  
  try{
    const res = await fetch('/api/delete-post', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ id }) 
    });
    
    if(!res.ok) throw new Error('åˆ é™¤è¯·æ±‚å¤±è´¥');
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'åˆ é™¤é”™è¯¯');
    
    await loadPosts();
    alert('å·²ç§»åŠ¨åˆ°åƒåœ¾æ¡¶');
  } catch(e){
    alert('åˆ é™¤å¤±è´¥ï¼š' + e.message);
    console.error(e);
  }
}

async function loadPosts(){
  try{
    const res = await fetch('/api/posts');
    if(!res.ok) throw new Error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥');
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'æ–‡ç« åˆ—è¡¨é”™è¯¯');
    renderPosts(j.posts || []);
  } catch(e){
    console.warn('åŠ è½½æ–‡ç« å¤±è´¥:', e);
    // é™çº§ï¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜
    const cached = JSON.parse(localStorage.getItem(PUBLISHED_FEED) || '[]');
    renderPosts(cached);
  }
}

function renderPosts(posts){
  el.feed.innerHTML = '';
  
  if (!posts || posts.length === 0) {
    el.feed.innerHTML = '<div style="color:#888;padding:40px;text-align:center">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå†™ä¸€ç¯‡å§ï¼</div>';
    return;
  }
  
  for(const p of posts.slice().reverse()){
    const node = document.createElement('article'); 
    node.className = 'post';
    
    const meta = document.createElement('div'); 
    meta.className = 'meta';
    
    const left = document.createElement('div'); 
    left.innerHTML = `<div class="title">${p.title || 'æ— æ ‡é¢˜'}</div>`;
    
    const right = document.createElement('div'); 
    right.className = 'small-muted'; 
    right.textContent = p.publishedReadable || p.publishedAtISO || 'æœªçŸ¥æ—¶é—´';
    
    meta.appendChild(left); 
    meta.appendChild(right);
    
    const text = document.createElement('div'); 
    text.className = 'text';
    
    // æ¸²æŸ“å†…å®¹ï¼ŒåŒ…æ‹¬åª’ä½“
    if (p.content) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = p.content;
      
      // å¤„ç†åª’ä½“å†…å®¹ï¼ˆåªè¯»æ¨¡å¼ï¼‰
      const mediaItems = tempDiv.querySelectorAll('.media-item');
      mediaItems.forEach(item => {
        const mediaUrl = item.dataset.mediaUrl;
        const caption = item.dataset.caption;
        const type = item.dataset.type;
        
        if (!mediaUrl) return;
        
        const mediaContainer = document.createElement('div');
        mediaContainer.className = 'media-container';
        
        const mediaItem = document.createElement('div');
        mediaItem.className = 'media-item';
        
        if (type === 'video') {
          const video = document.createElement('iframe');
          video.className = 'drive-video';
          video.src = mediaUrl;
          video.frameBorder = '0';
          video.allow = 'autoplay; encrypted-media';
          video.allowFullscreen = true;
          video.style.width = '100%';
          video.style.height = '400px';
          mediaItem.appendChild(video);
        } else {
          const img = document.createElement('img');
          img.className = 'drive-image';
          img.src = mediaUrl;
          img.alt = caption || 'Google Driveå›¾ç‰‡';
          img.style.maxWidth = '100%';
          img.style.maxHeight = '400px';
          img.style.display = 'block';
          img.style.margin = '0 auto';
          img.onerror = function() {
            this.style.display = 'none';
            const errorDiv = document.createElement('div');
            errorDiv.style.padding = '20px';
            errorDiv.style.textAlign = 'center';
            errorDiv.style.color = '#999';
            errorDiv.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æƒé™';
            mediaItem.appendChild(errorDiv);
          };
          mediaItem.appendChild(img);
        }
        
        if (caption) {
          const captionDiv = document.createElement('div');
          captionDiv.className = 'media-caption';
          captionDiv.textContent = caption;
          mediaItem.appendChild(captionDiv);
        }
        
        mediaContainer.appendChild(mediaItem);
        item.replaceWith(mediaContainer);
      });
      
      text.innerHTML = tempDiv.innerHTML;
    }
    
    const actions = document.createElement('div'); 
    actions.style.marginTop = '10px';
    
    const delBtn = document.createElement('button'); 
    delBtn.className = 'btn'; 
    delBtn.textContent = 'åˆ é™¤';
    delBtn.onclick = () => deletePost(p.id, p.title);
    
    actions.appendChild(delBtn);
    
    node.appendChild(meta); 
    node.appendChild(text);
    node.appendChild(actions);
    
    el.feed.appendChild(node);
  }
}

// ============================================
// ç½‘ç»œçŠ¶æ€ç®¡ç†
// ============================================
window.addEventListener('online', async () => {
  online = true;
  el.connStatus.textContent = 'åœ¨çº¿';
  el.connStatus.style.color = 'green';
  
  // é‡æ–°è”ç½‘åç«‹å³å¤‡ä»½ä¸€æ¬¡
  if (currentDraft && (currentDraft.title || currentDraft.content)) {
    backupToCloud();
  }
});

window.addEventListener('offline', () => { 
  online = false; 
  el.connStatus.textContent = 'ç¦»çº¿'; 
  el.connStatus.style.color = 'crimson'; 
});

// ============================================
// è‰ç¨¿åŠ è½½
// ============================================
el.loadDraftBtn.addEventListener('click', () => {
  currentDraft = loadLocalDraft();
  el.title.value = currentDraft.title || '';
  
  // æ¸²æŸ“å†…å®¹ï¼ŒåŒ…æ‹¬åª’ä½“
  if (currentDraft.content) {
    el.content.innerHTML = renderMediaToContent(el.content, currentDraft.content);
  } else {
    el.content.innerHTML = '';
  }
  
  el.weather.value = currentDraft.weather || '';
  alert('è‰ç¨¿å·²è½½å…¥');
});

// ============================================
// åª’ä½“åŠŸèƒ½äº‹ä»¶ç›‘å¬
// ============================================
el.insertMediaBtn.addEventListener('click', showMediaDialog);
el.cancelMediaBtn.addEventListener('click', hideMediaDialog);
el.insertMediaConfirmBtn.addEventListener('click', insertMedia);

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
el.mediaOverlay.addEventListener('click', (e) => {
  if (e.target === el.mediaOverlay) {
    hideMediaDialog();
  }
});

// æŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && el.mediaOverlay.style.display === 'flex') {
    hideMediaDialog();
  }
});

// ============================================
// åƒåœ¾æ¡¶åŠŸèƒ½
// ============================================
el.openTrashBtn.addEventListener('click', async () => {
  el.trashOverlay.style.display = 'block';
  el.trashPanel.style.display = 'block';
  await loadTrash();
});

el.closeTrashBtn.addEventListener('click', () => { 
  el.trashOverlay.style.display = 'none';
  el.trashPanel.style.display = 'none';
});

el.trashOverlay.addEventListener('click', () => { 
  el.trashOverlay.style.display = 'none';
  el.trashPanel.style.display = 'none';
});

async function loadTrash(){
  el.trashList.innerHTML = 'åŠ è½½ä¸­â€¦';
  try{
    const res = await fetch('/api/trash');
    if(!res.ok) throw new Error('åŠ è½½åƒåœ¾æ¡¶å¤±è´¥');
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'åƒåœ¾æ¡¶é”™è¯¯');
    renderTrash(j.trash || []);
  } catch(e){
    el.trashList.innerHTML = '<div style="color:#888;padding:20px;text-align:center">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>';
    console.error('åŠ è½½åƒåœ¾æ¡¶å¤±è´¥:', e);
  }
}

function renderTrash(items){
  el.trashList.innerHTML = '';
  
  if(!items.length){ 
    el.trashList.innerHTML = '<div style="color:#888;padding:20px;text-align:center">åƒåœ¾æ¡¶ç©ºç©ºå¦‚ä¹Ÿ</div>'; 
    return; 
  }
  
  for(const it of items){
    const row = document.createElement('div'); 
    row.className = 'trash-item';
    
    const left = document.createElement('div'); 
    left.style.flex = '1';
    left.innerHTML = `
      <div style="font-weight:600">${it.title || 'æ— æ ‡é¢˜'}</div>
      <div class="time">åˆ é™¤æ—¶é—´ï¼š${new Date(it.deletedAt).toLocaleString()}</div>
    `;
    
    const actions = document.createElement('div'); 
    actions.className = 'trash-actions';
    
    const restore = document.createElement('button'); 
    restore.className = 'btn'; 
    restore.textContent = 'æ¢å¤';
    restore.onclick = async () => {
      if(!confirm('ç¡®è®¤æ¢å¤æ­¤æ—¥è®°ï¼Ÿ')) return;
      try{
        const r = await fetch('/api/restore-post', { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({ id: it.id })
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'æ¢å¤é”™è¯¯');
        alert('å·²æ¢å¤');
        await loadTrash();
        await loadPosts();
      } catch(e){ 
        alert('æ¢å¤å¤±è´¥ï¼š' + e.message); 
      }
    };
    
    const perm = document.createElement('button'); 
    perm.className = 'btn'; 
    perm.textContent = 'æ°¸ä¹…åˆ é™¤';
    perm.onclick = async () => {
      if(!confirm('æ°¸ä¹…åˆ é™¤åæ— æ³•æ¢å¤ã€‚ç¡®è®¤æ°¸ä¹…åˆ é™¤ï¼Ÿ')) return;
      try{
        const r = await fetch('/api/delete-permanent', { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({ id: it.id })
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'æ°¸ä¹…åˆ é™¤é”™è¯¯');
        alert('å·²æ°¸ä¹…åˆ é™¤');
        await loadTrash();
      } catch(e){ 
        alert('åˆ é™¤å¤±è´¥ï¼š' + e.message); 
      }
    };
    
    actions.appendChild(restore); 
    actions.appendChild(perm);
    row.appendChild(left); 
    row.appendChild(actions);
    el.trashList.appendChild(row);
  }
}

// ============================================
// åˆå§‹åŒ–
// ============================================
(function init(){
  // åˆå§‹åŒ–è‰ç¨¿
  currentDraft = loadLocalDraft();
  el.title.value = currentDraft.title || '';
  
  // æ¸²æŸ“å†…å®¹ï¼ŒåŒ…æ‹¬åª’ä½“
  if (currentDraft.content) {
    el.content.innerHTML = renderMediaToContent(el.content, currentDraft.content);
  } else {
    el.content.innerHTML = '';
  }
  
  el.weather.value = currentDraft.weather || '';
  
  // åˆå§‹åŒ–ç½‘ç»œçŠ¶æ€
  el.connStatus.textContent = navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿';
  el.connStatus.style.color = navigator.onLine ? 'green' : 'crimson';
  
  // å¯åŠ¨è‡ªåŠ¨ä¿å­˜
  startAutosave();
  
  // åŠ è½½å·²å‘å¸ƒæ–‡ç« 
  loadPosts();
  
  // æ›´æ–°æ—¶é—´æ˜¾ç¤º
  setInterval(() => {
    el.dateLine.innerText = formatFullTimestamp(new Date());
  }, 1000);
  
  // è¾“å…¥äº‹ä»¶ç›‘å¬
  const handleInput = () => {
    scheduleBackup(); // è§¦å‘é˜²æŠ–å¤‡ä»½
  };
  
  el.content.addEventListener('input', () => {
    saveContentToDraft();
    handleInput();
  });
  
  el.title.addEventListener('input', () => {
    currentDraft.title = el.title.value;
    saveLocalDraft(currentDraft);
    handleInput();
  });
  
  el.weather.addEventListener('input', () => {
    currentDraft.weather = el.weather.value;
    saveLocalDraft(currentDraft);
    handleInput();
  });
  
  // ç›‘å¬å†…å®¹å˜åŒ–ï¼Œå¤„ç†åª’ä½“ç§»é™¤
  el.content.addEventListener('click', (e) => {
    if (e.target.classList.contains('media-remove')) {
      e.stopPropagation();
    }
  });
})();
</script>
</body>
</html>